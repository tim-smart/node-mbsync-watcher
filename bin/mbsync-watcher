#!/usr/bin/env node

var watch        = require('node-watch')
var path         = require('path')
var childprocess = require('child_process')
var datef        = require('dateformat')
var channel      = process.argv[2]
var mailbox      = process.argv[3]

var MBSYNC       = 'mbsync'
var INTERVAL     = 60000 // For full syncs

if (!channel) {
  console.error('No channel specified.')
  return process.exit(1)
}

if (!mailbox) {
  console.error('No mailbox specified.')
  return process.exit(1)
}

mailbox         = path.resolve(mailbox)

function log () {
  var message =
    [ datef(new Date, 'yyyy-mm-dd HH:MM:ss')
    , '[SYNC]'
    ]

  message.push.apply(message, arguments)

  console.error(message.join(' - '))
}

function filetofolder (file) {
  var folders = file.slice(mailbox.length + 1).split('/')
  var out     = []
  var folder  = ''
  var stop    = false

  for (var i = 0, il = folders.length; i < il; i++) {
    folder = folders[i]

    switch (folder) {
    case 'cur':
    case 'new':
    case 'tmp':
      stop = true
      break
    case 'Inbox':
      out.push('INBOX')
      stop = true
      break
    default:
      if ('.' === folder[0]) folder = folder.slice(1)
      if ('uidvalidity' === folder) break
      out.push(folder)
      break
    }

    if (stop) break
  }

  return out.join('/')
}

var current = null
var queue   = []
var syncing = false

function runmbsync (folder, tosync) {
  tosync || (tosync = channel)

  if (folder) {
    tosync = tosync + ':' + folder
  }

  if (syncing) {
    if (
       channel !== queue[0]
    && !(channel === current && channel === tosync)
    && -1 === queue.indexOf(tosync)
    ) {
      log('QUEUED', tosync)

      if (channel === tosync) {
        queue = [channel]
      } else {
        queue.unshift(tosync)
      }
    }

    return
  }

  log(tosync)

  var sync      = childprocess.spawn(MBSYNC, [tosync])
  var buffer    = []
  var previous  = []
  syncing       = true
  current       = tosync

  function checkqueue () {
    var tocheck = ''
    var index   = 0

    for (var i = 0, il = previous.length; i < il; i++) {
      tocheck = previous[i]

      index = queue.indexOf(tocheck)
      if (-1 === index) continue

      queue.splice(index, 1)
      log('UNQUEUED', tocheck)

      previous = []
    }
  }

  function checkchanges () {
    var string  = buffer.join('')
    var regex   = /\nSelecting slave (.*)\.\.\.\n/
    var match   = null
    var matches = []
    var tocheck = ''
    var index   = 0

    while (match = string.match(regex)) {
      string   = string.slice(match.index + match[0].length)
      tocheck  = channel + ':' + match[1]
      matches.push(tocheck)

      if (tosync !== tocheck) {
        log(tosync, 'MAILBOX', match[1])
      }
    }

    // Queue
    if (0 < matches.length) {
      setTimeout(function () {
        checkqueue()
        previous = matches
      }, 500)
    }

    buffer = [string]
  }

  sync.stdout.setEncoding('utf8')
  sync.stdout.on('readable', function () {
    buffer.push(sync.stdout.read())
    checkchanges()
  })

  sync.stderr.setEncoding('utf8')
  sync.stderr.on('readable', function () {
    buffer.push(sync.stderr.read())
    checkchanges()
  })

  sync.on('exit', function () {
    setTimeout(checkqueue, 500)
    log(tosync, 'COMPLETE')

    syncing = false
    current = null

    var next = queue.pop()
    if (next) runmbsync(null, next)
  })
}

function onchange (file) {
  runmbsync(filetofolder(file))
}

var fullcounter = 0

function dofullsync () {
  // Sync all folders every 5 minutes
  if (4 <= fullcounter) {
    fullcounter = 0
    runmbsync()
    return
  }

  runmbsync('INBOX')
  ;++fullcounter
}

setInterval(dofullsync, INTERVAL)

// First run
runmbsync()
watch(mailbox, onchange)

// vim: set filetype=javascript :
